#!/usr/bin/env python

import os
import sys
import argparse
import tempfile
import xmlrpclib
import re

PYPI_ENDPOINT = "http://pypi.python.org/pypi"

parser = argparse.ArgumentParser()
parser.add_argument("-v", "--verbose", action="store_true", default=False)
parser.add_argument("package", metavar='PACKAGE')
args = parser.parse_args()

package = args.package
client = xmlrpclib.ServerProxy(PYPI_ENDPOINT)
releases = client.package_releases(package)

if len(releases) == 0:
    sys.stderr.write("Could not find a valid package '%s'\n" % package)
    exit(1)

main_release = releases[0]
data    = client.release_data(package, main_release)
name    = data['name'].lower()
klass   = "".join(map(str.capitalize, re.findall('[a-zA-Z]+', data['name'])))

filename = "%s/%s.rb" % (tempfile.gettempdir(), name)
f = open(filename, 'w')

formula_contents = """
require 'formula'

class PipFormula < Formula
  class NoopDownloadStrategy < AbstractDownloadStrategy
    def fetch; end
    def stage; end
  end

  def download_strategy
    NoopDownloadStrategy
  end

  def install
    system "pip", "install", "#{name}==#{version}",
      "--install-option=--prefix=#{prefix}"
  end
end

class %(klass)s < PipFormula
  url "%(url)s"
  version "%(version)s"
  homepage "%(homepage)s"
end
""".strip() % {'klass': klass, 'url': data['download_url'], 'homepage': data['home_page'], 'version': data['version']}

f.write(formula_contents+"\n")
f.close()

if args.verbose:
    print "Formula is:"
    print formula_contents

os.system("brew install %s %s" % ("-v" if args.verbose else "", filename))
os.remove(filename)
